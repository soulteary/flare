<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flare åœ¨çº¿æ•°æ®ç¼–è¾‘</title>

    <link rel="stylesheet" href="/assets/editor/handsontable.full.min.css">
    <script src="/assets/editor/handsontable.full.min.js"></script>
    <script src="/assets/editor/zh-CN.min.js"></script>
    <style>
        body {
            --color-background: #1a1a1a;
            --color-primary: #FFFDEA;
            --color-accent: #5c5c5c;
            --spacing-ui: 10px;
            background-color: var(--color-background);
            transition: background-color 0.3s;
            font-family: Roboto, sans-serif;
            font-size: 14px;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        .notice {
            color: var(--color-primary);
        }

        .bookmark-icon {
            background-color: var(--color-background) !important;
        }

        .bookmark-icon img {
            height: 90%;
        }

        #search-container {
            background-color: #fff;
            padding: 10px;
        }
    </style>
</head>

<body>
    <h1>Flare åœ¨çº¿æ•°æ®ç¼–è¾‘</h1>
    <p class="notice">å—¨ğŸ‘‹ï¼Œåœ¨çº¿ç¼–è¾‘åŠŸèƒ½è¿˜åœ¨å¼€å‘ä¸­ï¼Œç›®å‰å·²æ»¡è¶³åŸºæœ¬åŠŸèƒ½ï¼Œæ•…å¼€æ”¾ä½¿ç”¨ã€‚</p>
    <p class="notice">åœ¨ä½¿ç”¨æœ¬ç¼–è¾‘å™¨å‰ï¼Œå¼ºçƒˆå»ºè®®å…ˆæ‰‹åŠ¨ä¿å­˜æ‚¨çš„æ•°æ®æ–‡ä»¶ï¼ˆå¦‚ä½¿ç”¨ Git è¿›è¡Œç‰ˆæœ¬ç®¡ç†ã€æˆ–å®šæ—¶è¿›è¡Œæ•°æ®å¤‡ä»½ï¼‰ï¼Œé¿å…å› æµè§ˆå™¨å…¼å®¹æ€§å·®å¼‚å¯¼è‡´çš„æå°æ¦‚ç‡çš„ç³Ÿç³•çŠ¶å†µå‡ºç°ã€‚</p>
    <p class="notice">ä½¿ç”¨æ–¹æ³•ï¼šåœ¨é¡µé¢ä¸­çš„ â€œExcelâ€ ä¸­å®Œæˆä½ æƒ³è¦çš„æ•°æ®æ›´æ–°ï¼Œæˆ–å†…å®¹æ·»åŠ ï¼ˆå³é”®æ·»åŠ â€œæ–°è¡Œâ€ï¼‰ä¹‹åï¼Œç‚¹å‡»ä»»æ„ä¿å­˜æŒ‰é’®ï¼Œå³å¯å®Œæˆä¹¦ç­¾æ•°æ®çš„ä¿®æ”¹ã€‚</p>

    <h2>åˆ†ç±»ç®¡ç†</h2>
    <div id="container-category"></div>
    <div class="controls">
        <input type="submit" value="ä¿å­˜æ•°æ®" class="update-data" style="margin-top: 10px;" />
        <form action="/editor" method="POST" id="form-categories">
            <input type="hidden" name="categories" id="field-categories" value="" />
            <input type="hidden" name="bookmarks" id="field-bookmarks" value="" />
        </form>
    </div>

    <h2>åº”ç”¨ç¼–è¾‘</h2>

    <div id="search-container" style="text-align: right;">
        <span style="float: left; margin: 2px;">
            <span>é«˜äº®ç­›é€‰:</span>
            <input type="text" name="" id="search">
        </span>
        <input style="margin: 0 10px;" type="submit" value="ä¿å­˜æ•°æ®" class="update-data" />
        <input type="submit" value="è¿”å›é¦–é¡µ" id="back-home" />
    </div>

    <div id="container-bookmarks"></div>

    <script type="text/html" id="data-categories">{{.DataCategories}}</script>
    <script type="text/html" id="data-bookmarks">{{.DataBookmarks}}</script>

    <script>
        let categories = JSON.parse(document.getElementById("data-categories").innerHTML) || [];
        const dataBookmarks = JSON.parse(document.getElementById("data-bookmarks").innerHTML) || [];

        let categoriesMap = categories.reduce((prev, item) => {
            prev[item.ID] = item.Name; return prev;
        }, {})
        const FLARE_FIX_CATEGORY = ["[Flare åº”ç”¨]"];
        let bookmarks = dataBookmarks.filter(item => item.Category && item.Name && item.URL).map(item => {
            if (item.Category === '_FLARE_FIXED_CATEGORY') {
                item.Category = FLARE_FIX_CATEGORY[0];
            } else {
                item.Category = categoriesMap[item.Category]
            }
            return item;
        }).sort((a, b) => (a.Category + "").localeCompare(b.Category + ""));
    </script>

    <script>
        const instanceCategories = new Handsontable(document.getElementById('container-category'), {
            language: 'zh-CN',
            data: categories,
            colHeaders: ['åˆ†ç±»åç§°'],
            rowHeaders: true,
            manualRowMove: true,
            contextMenu: ["row_above", "row_below", "---------", "undo", "redo", "---------", "cut", "copy"],
            columns: [
                { data: 'Name' },
            ],
            height: 'auto',
            afterChange: (changes) => {
                if (!changes) { return }
                changes.forEach(function ([row, prop, oldValue, newValue]) {
                    categoriesMap = Object.keys(categoriesMap).reduce(function (prev, key) {
                        if (categoriesMap[key] == oldValue) {
                            prev[key] = newValue;
                        } else {
                            prev[key] = categoriesMap[key]
                        }
                        return prev;
                    }, {});

                    bookmarks = bookmarks.map(function (bookmark) {
                        if (bookmark.Category == oldValue) {
                            bookmark.Category = newValue;
                        }
                        return bookmark;
                    });
                });
                updateDataTable()
            },
            licenseKey: 'non-commercial-and-evaluation'
        });

        function coverRenderer(instance, td, row, col, prop, value, cellProperties) {
            const stringifiedValue = Handsontable.helper.stringify(value);

            Handsontable.renderers.TextRenderer.apply(this, arguments);
            return;

            if (stringifiedValue.startsWith('http')) {
                const img = document.createElement('IMG');

                img.src = value;

                Handsontable.dom.addEvent(img, 'mousedown', event => {
                    event.preventDefault(); // prevent selection quirk
                });

                Handsontable.dom.empty(td);
                td.appendChild(img);
            } else if (stringifiedValue !== '') {

                const img = document.createElement('IMG');

                img.src = '/assets/mdi/blackboard-' + (value + '').toLowerCase() + '.svg';

                Handsontable.dom.addEvent(img, 'mousedown', event => {
                    event.preventDefault(); // prevent selection quirk
                });

                Handsontable.dom.empty(td);
                td.className = 'bookmark-icon'
                td.appendChild(img);

            } else {
                Handsontable.renderers.TextRenderer.apply(this, arguments);
            }
        }


        const searchField = document.querySelector('#search');
        const container = document.getElementById('container-bookmarks');
        const dataTableColumns = buildDataTableColumns();
        let instanceBookmarks = new Handsontable(container, {
            language: 'zh-CN',
            data: Array.from(bookmarks),
            colHeaders: ['ä¹¦ç­¾åç§°', 'ä¹¦ç­¾åœ°å€', /*'ç§å¯†',*/ 'ç±»å‹', 'å›¾æ ‡', 'æè¿°'],
            rowHeaders: true,
            manualRowMove: true,
            contextMenu: ["row_above", "row_below", "---------", "undo", "redo", "---------", "cut", "copy"],
            columns: dataTableColumns,
            // hiddenColumns: true,
            // hiddenColumns: {
            //     columns: [2],
            //     copyPasteEnabled: false,
            //     indicators: false
            // },
            height: 'auto',
            stretchH: 'all',
            search: true,
            licenseKey: 'non-commercial-and-evaluation'
        });
        Handsontable.dom.addEvent(searchField, 'keyup', function (event) {
            const queryResult = instanceBookmarks.getPlugin('search').query(this.value);
            instanceBookmarks.render();
        });


        function bindData() {
            const options = { bom: false, columnDelimiter: ',', columnHeaders: false, exportHiddenColumns: true, exportHiddenRows: true, rowDelimiter: '\r\n', rowHeaders: true };
            const exportedCategories = instanceCategories.getPlugin('exportFile').exportAsString('csv', options);
            const exportedBookmarks = instanceBookmarks.getPlugin('exportFile').exportAsString('csv', options);
            document.getElementById('field-categories').value = exportedCategories;
            document.getElementById('field-bookmarks').value = exportedBookmarks;
        }

        Array.from(document.getElementsByClassName('update-data')).forEach(function (btn) {
            btn.addEventListener('click', function (event) {
                event.preventDefault();
                bindData();
                document.getElementById('form-categories').submit();
            });
        });

        function buildDataTableColumns() {
            return [
                { data: 'Name' },
                { data: 'URL' },
                // { data: 'Private', type: 'checkbox' },
                { data: 'Category', editor: 'select', selectOptions: FLARE_FIX_CATEGORY.concat(categories.map(item => item.Name)), allowInvalid: false },
                { data: 'Icon', renderer: coverRenderer },
                { data: 'Desc' }
            ]
        }

        document.getElementById('back-home').addEventListener('click', function (e) {
            e.preventDefault();
            location.href = "/";
        })


        function updateDataTable() {
            instanceBookmarks.updateData(bookmarks)
            instanceBookmarks.updateSettings({ columns: buildDataTableColumns() })
        }

    </script>


</body>

</html>